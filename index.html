<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Eredivisie Fantasy Stats</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background-color: #fafafa;
      }
      h1 {
        color: #333;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 30px;
      }
      th, td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #eee;
      }
      input, select, button {
        margin-right: 10px;
        padding: 6px;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      function App() {
        const [players, setPlayers] = React.useState([]);
        const [captains, setCaptains] = React.useState([]);
        const [loading, setLoading] = React.useState(true);
        const [fplId, setFplId] = React.useState("");
        const [rankFilter, setRankFilter] = React.useState("10000");

        async function fetchCaptains() {
          try {
            const res = await fetch(
              `https://efvdata-production.up.railway.app/api/captains?topManagersCount=${rankFilter}`
            );
            const data = await res.json();
            setCaptains(data.captains || []);
          } catch (err) {
            console.error("Captain load error:", err);
          }
        }

        async function fetchPlayers() {
          if (!fplId) return;
          try {
            setLoading(true);
            const res = await fetch(
              `https://efvdata-production.up.railway.app/api/players?fplId=${fplId}&topManagersCount=${rankFilter}`
            );
            const data = await res.json();
            setPlayers(data.players || []);
          } catch (err) {
            console.error("Player load error:", err);
          } finally {
            setLoading(false);
          }
        }

        // Preload captains on page open
        React.useEffect(() => {
          fetchCaptains().finally(() => setLoading(false));
        }, []);

        if (loading) return <p>Loading...</p>;

        return (
          <div>
            <h1>Eredivisie Fantasy Stats</h1>

            {/* Input area */}
            <div>
              <input
                type="text"
                placeholder="Enter FPL ID"
                value={fplId}
                onChange={(e) => setFplId(e.target.value)}
              />
              <button onClick={fetchPlayers}>Apply ID</button>

              <select
                value={rankFilter}
                onChange={(e) => setRankFilter(e.target.value)}
              >
                <option value="100">Top 100</option>
                <option value="1000">Top 1,000</option>
                <option value="10000">Top 10,000</option>
              </select>
              <button onClick={fetchCaptains}>Apply Rank</button>
            </div>

            {/* Captains Table */}
            {captains.length > 0 && (
              <>
                <h2>Top 10 Captains (Speelronde 9)</h2>
                <table>
                  <thead>
                    <tr>
                      <th>Player</th>
                      <th>Captain %</th>
                    </tr>
                  </thead>
                  <tbody>
                    {captains.map((c, i) => (
                      <tr key={i}>
                        <td>{c.name}</td>
                        <td>{c.captain_percent?.toFixed(2)}%</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </>
            )}

            {/* Players Table */}
            {players.length > 0 && (
              <>
                <h2>Most Selected Players</h2>
                <table>
                  <thead>
                    <tr>
                      <th>Player</th>
                      <th>Team</th>
                      <th>Ownership %</th>
                    </tr>
                  </thead>
                  <tbody>
                    {players.map((p, i) => (
                      <tr key={i}>
                        <td>{p.name}</td>
                        <td>{p.team}</td>
                        <td>{p.ownership?.toFixed(2)}%</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </>
            )}
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
